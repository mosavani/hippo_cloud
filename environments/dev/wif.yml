# -----------------------------------------------------------------------
# Workload Identity Federation configuration
#
# workloads: in-cluster K8s ServiceAccount → GCP SA bindings
#   name                - short workload name, used to name the GCP SA
#   k8s_namespace       - Kubernetes namespace the workload runs in
#   k8s_service_account - Kubernetes ServiceAccount name
#   gcp_roles           - GCP IAM roles to grant the workload SA
#
# github_ci: GitHub Actions → GCP SA bindings (no K8s SA involved)
#   name                - short name, used to name the GCP SA
#   github_repo         - GitHub repo in 'owner/repo' format (per-repo binding)
#   github_org          - GitHub org/user login (per-org binding — all repos in org)
#   gcp_roles           - GCP IAM roles to grant the SA
# Use github_org when all service repos share the same SA and registry.
# Use github_repo for tighter scoping when repos need different SAs/roles.
# -----------------------------------------------------------------------
workloads:
  - name: frontend-web
    k8s_namespace: default
    k8s_service_account: frontend-web
    gcp_roles:
      - roles/storage.objectViewer

  # argocd-repo-server — pulls OCI Helm charts from GAR via docker-credential-gcr.
  # The WIF binding lets the pod exchange its metadata server token for a
  # short-lived OAuth2 token that ArgoCD's go-containerregistry client accepts.
  - name: argocd-repo-server
    k8s_namespace: argocd
    k8s_service_account: argocd-repo-server
    gcp_roles:
      - roles/artifactregistry.reader

  # External Secrets Operator — reads the ArgoCD GAR SA key from Secret Manager.
  # The secretmanager.secretAccessor grant on the specific secret is declared
  # inline in environments/dev/main.tf (not a project-level role).
  - name: eso
    k8s_namespace: external-secrets
    k8s_service_account: external-secrets
    gcp_roles:
      - roles/artifactregistry.reader  # GCRAccessToken generator: get OAuth2 token for GAR OCI pulls

github_ci:
  - name: hippo-helm-publisher
    github_repo: mosavani/hippo_k8s-service
    gcp_roles:
      - roles/artifactregistry.writer

  - name: hippo-image-publisher
    github_org: mosavani
    gcp_roles:
      - roles/artifactregistry.writer
