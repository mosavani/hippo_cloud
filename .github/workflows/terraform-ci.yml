# -----------------------------------------------------------------------
# CI: Terraform lint, validate, and plan on every PR
# Apply runs only on merge to main for the dev environment.
#
# Secrets required (set in GitHub repo Settings → Secrets and variables):
#   GCP_WORKLOAD_IDENTITY_PROVIDER  — WIF provider resource name
#   GCP_SERVICE_ACCOUNT             — SA email that CI impersonates
#   TF_STATE_BUCKET_DEV             — GCS bucket for dev state
#
# Secrets are never printed; they flow into the workflow only as env vars.
# -----------------------------------------------------------------------
name: Terraform CI

on:
  pull_request:
    branches: [main]
    paths:
      - "environments/**"
      - "modules/**"
      - ".github/workflows/terraform-ci.yml"
  push:
    branches: [main]
    paths:
      - "environments/**"
      - "modules/**"

permissions:
  contents: read
  id-token: write        # Required for Workload Identity Federation
  pull-requests: write   # Allow posting plan output as PR comment

env:
  TF_VERSION: "1.7.5"
  TF_INPUT: "false"
  TF_CLI_ARGS: "-no-color"

jobs:
  # -----------------------------------------------------------------------
  # Format check: terraform fmt --check
  # -----------------------------------------------------------------------
  fmt:
    name: Format check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Check formatting
        run: terraform fmt -recursive -check

  # -----------------------------------------------------------------------
  # Lint: tflint
  # -----------------------------------------------------------------------
  lint:
    name: tflint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init tflint plugins
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tflint (modules)
        run: tflint --recursive --chdir=modules

      - name: Run tflint (environments)
        run: tflint --recursive --chdir=environments

  # -----------------------------------------------------------------------
  # Validate: terraform validate (no cloud credentials needed)
  # -----------------------------------------------------------------------
  validate:
    name: Validate (dev)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: terraform init (local backend for validation)
        working-directory: environments/dev
        run: terraform init -backend=false

      - name: terraform validate
        working-directory: environments/dev
        run: terraform validate

  # -----------------------------------------------------------------------
  # Plan: run terraform plan and post output as PR comment
  # -----------------------------------------------------------------------
  plan:
    name: Plan (dev)
    runs-on: ubuntu-latest
    needs: [fmt, lint, validate]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: true

      # Authenticate to GCP using Workload Identity Federation.
      # No long-lived credentials stored — OIDC token exchanged for a
      # short-lived GCP access token.
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: terraform init
        working-directory: environments/dev
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET_DEV }}" \
            -backend-config="prefix=$(yq '.state.prefix' values.yml)"

      - name: terraform plan
        id: plan
        working-directory: environments/dev
        run: terraform plan -detailed-exitcode -out=tfplan
        # exit code 0 = no changes, 1 = error, 2 = changes present
        continue-on-error: true

      - name: Post plan to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan — \`dev\`
            \`\`\`
            ${process.env.PLAN}
            \`\`\`
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Check plan exit code
        if: steps.plan.outputs.exitcode == '1'
        run: exit 1

  # -----------------------------------------------------------------------
  # Apply: dev only, on push to main (after PR merge)
  # -----------------------------------------------------------------------
  apply-dev:
    name: Apply (dev)
    runs-on: ubuntu-latest
    needs: [fmt, lint, validate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: dev
      url: https://console.cloud.google.com/kubernetes

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: terraform init
        working-directory: environments/dev
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET_DEV }}" \
            -backend-config="prefix=$(yq '.state.prefix' values.yml)"

      - name: terraform apply
        working-directory: environments/dev
        run: terraform apply -auto-approve
